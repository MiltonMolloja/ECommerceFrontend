@if (processing()) {
  <div class="processing-overlay">
    <h2>.. procesando la orden ..</h2>
  </div>
} @else {
  <div class="order-create-container">
    <div class="header">
      <h1>Nueva orden</h1>
      <p class="subtitle">Creación de una nueva orden de compra</p>
    </div>

    <form [formGroup]="orderForm" class="order-form">
      <!-- Payment Method -->
      <div class="form-field">
        <mat-form-field appearance="outline">
          <mat-label>Método de pago</mat-label>
          <mat-select formControlName="paymentType">
            @for (type of paymentTypes; track type.value) {
              <mat-option [value]="type.value">{{ type.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Client -->
      <div class="form-field">
        <mat-form-field appearance="outline">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="clientId" placeholder="Seleccione un cliente">
            @for (client of clients(); track client.clientId) {
              <mat-option [value]="client.clientId">{{ client.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Product -->
      <div class="form-field">
        <div class="product-selector">
          <mat-form-field appearance="outline">
            <mat-label>Producto</mat-label>
            <mat-select formControlName="productId" placeholder="Seleccione un producto">
              @for (product of products(); track product.productId) {
                <mat-option [value]="product.productId">{{ product.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addProduct()"
            [disabled]="!orderForm.get('productId')?.value"
          >
            Agregar
          </button>
        </div>
      </div>

      <!-- Items Table -->
      @if (orderItems().length > 0) {
        <div class="items-table-container">
          <table mat-table [dataSource]="orderItems()" class="items-table">
            <!-- Item Column -->
            <ng-container matColumnDef="item">
              <th mat-header-cell *matHeaderCellDef>Item</th>
              <td mat-cell *matCellDef="let item">
                {{ item.product?.name || 'Product ' + item.productId }}
              </td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Precio</th>
              <td mat-cell *matCellDef="let item">US$ {{ item.price | number: '1.2-2' }}</td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let item">
                <input
                  type="number"
                  [(ngModel)]="item.quantity"
                  [ngModelOptions]="{ standalone: true }"
                  min="1"
                  class="quantity-input"
                />
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let item">
                US$ {{ getItemTotal(item) | number: '1.2-2' }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let item">
                <button
                  mat-button
                  color="warn"
                  type="button"
                  (click)="removeItem(item.productId)"
                  class="remove-button"
                >
                  Retirar
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <div class="total-section">
            <span class="total-label">US$ {{ getTotal() | number: '1.2-2' }}</span>
          </div>
        </div>
      }

      <!-- Create Order Button -->
      <div class="form-actions">
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="createOrder()"
          [disabled]="orderForm.invalid || orderItems().length === 0"
          class="create-button"
        >
          Crear orden
        </button>
      </div>
    </form>
  </div>
}
