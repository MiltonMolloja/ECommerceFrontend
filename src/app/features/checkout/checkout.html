<div class="checkout-container">
  <!-- Progress Steps -->
  <mat-card class="progress-card">
    <div class="progress-steps">
      @for (step of getSteps(); track step.id; let last = $last) {
        <div class="step-wrapper">
          <div class="step-item">
            <div
              class="step-indicator"
              [class.completed]="step.completed"
              [class.active]="currentStep() === step.id"
            >
              @if (step.completed) {
                <mat-icon>check</mat-icon>
              } @else {
                {{ step.id }}
              }
            </div>
            <span class="step-title" [class.active]="currentStep() === step.id">{{
              step.title
            }}</span>
          </div>
          @if (!last) {
            <div class="step-divider" [class.completed]="step.completed"></div>
          }
        </div>
      }
    </div>
  </mat-card>

  <div class="checkout-content">
    <!-- Main Content -->
    <div class="checkout-main">
      <!-- Step 1: Shipping Address -->
      @if (currentStep() === 1) {
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>place</mat-icon>
              </div>
              <mat-card-title>1. Dirección de envío</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="shippingForm" (ngSubmit)="submitShippingForm()">
              <div class="form-grid">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre completo *</mat-label>
                  <input matInput formControlName="fullName" placeholder="Juan Pérez" />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Teléfono *</mat-label>
                  <input
                    matInput
                    type="tel"
                    formControlName="phoneNumber"
                    placeholder="+54 11 1234-5678"
                  />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Dirección línea 1 *</mat-label>
                  <input
                    matInput
                    formControlName="addressLine1"
                    placeholder="Calle Principal 123"
                  />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Dirección línea 2</mat-label>
                  <input
                    matInput
                    formControlName="addressLine2"
                    placeholder="Apartamento, suite, etc."
                  />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Ciudad *</mat-label>
                  <input matInput formControlName="city" placeholder="Buenos Aires" />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Estado/Provincia</mat-label>
                  <input matInput formControlName="state" placeholder="CABA" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Código postal *</mat-label>
                  <input matInput formControlName="zipCode" placeholder="C1000" />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>País *</mat-label>
                  <mat-select formControlName="country">
                    @for (country of countries; track country.value) {
                      <mat-option [value]="country.value">{{ country.label }}</mat-option>
                    }
                  </mat-select>
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>
              </div>

              <button mat-raised-button type="submit" class="submit-button" color="primary">
                Continuar al pago
              </button>
            </form>
          </mat-card-content>
        </mat-card>
      }

      <!-- Step 2: Payment Method -->
      @if (currentStep() === 2) {
        <!-- Shipping Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>1. Dirección de envío</mat-card-title>
              <button mat-button type="button" (click)="goToStep(1)" class="change-button">
                Cambiar
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div>{{ shippingForm.get('fullName')?.value }}</div>
              <div>{{ shippingForm.get('addressLine1')?.value }}</div>
              @if (shippingForm.get('addressLine2')?.value) {
                <div>{{ shippingForm.get('addressLine2')?.value }}</div>
              }
              <div>
                {{ shippingForm.get('city')?.value }}
                @if (shippingForm.get('state')?.value) {
                  , {{ shippingForm.get('state')?.value }}
                }
                {{ shippingForm.get('zipCode')?.value }}
              </div>
              <div>{{ shippingForm.get('country')?.value }}</div>
              <div class="phone">{{ shippingForm.get('phoneNumber')?.value }}</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Payment Form -->
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>credit_card</mat-icon>
              </div>
              <mat-card-title>2. Método de pago</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="secure-info">
              <mat-icon>lock</mat-icon>
              <span>Transacción segura y encriptada con MercadoPago</span>
            </div>

            @if (isInitializingPayment) {
              <div class="loading-payment">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Inicializando servicio de pagos...</p>
              </div>
            }

            <form [formGroup]="paymentForm" (ngSubmit)="submitPaymentForm()">
              <div class="form-grid">
                <!-- Card Information -->
                <div class="section-title full-width">Información de la tarjeta</div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Número de tarjeta *</mat-label>
                  <input
                    matInput
                    formControlName="cardNumber"
                    placeholder="1234 5678 9012 3456"
                    (input)="formatCardNumber($event)"
                    maxlength="19"
                  />
                  <mat-icon matSuffix>credit_card</mat-icon>
                  <mat-error>Número de tarjeta inválido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre del titular *</mat-label>
                  <input
                    matInput
                    formControlName="cardholderName"
                    placeholder="JUAN PEREZ"
                    style="text-transform: uppercase"
                  />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Mes (MM) *</mat-label>
                  <input
                    matInput
                    formControlName="expirationMonth"
                    placeholder="12"
                    (input)="formatExpirationMonth($event)"
                    maxlength="2"
                  />
                  <mat-error>Mes inválido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Año (YY) *</mat-label>
                  <input
                    matInput
                    formControlName="expirationYear"
                    placeholder="25"
                    (input)="formatExpirationYear($event)"
                    maxlength="2"
                  />
                  <mat-error>Año inválido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>CVV *</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="cvv"
                    placeholder="123"
                    (input)="formatCVV($event)"
                    maxlength="4"
                  />
                  <mat-icon
                    matSuffix
                    matTooltip="Código de seguridad de 3 o 4 dígitos al reverso de la tarjeta"
                    >help_outline</mat-icon
                  >
                  <mat-error>CVV inválido</mat-error>
                </mat-form-field>

                <!-- Cardholder Identification -->
                <div class="section-title full-width">Identificación del titular</div>

                <mat-form-field appearance="outline">
                  <mat-label>Tipo de documento *</mat-label>
                  <mat-select formControlName="identificationType">
                    @for (idType of identificationTypes; track idType.id) {
                      <mat-option [value]="idType.id">{{ idType.name }}</mat-option>
                    }
                  </mat-select>
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Número de documento *</mat-label>
                  <input matInput formControlName="identificationNumber" placeholder="12345678" />
                  <mat-error>Este campo es requerido</mat-error>
                </mat-form-field>

                <!-- Billing Address Section -->
                <div class="section-title full-width">Dirección de facturación</div>

                <div class="checkbox-field full-width">
                  <mat-checkbox formControlName="billingSameAsShipping">
                    Usar la misma dirección de envío
                  </mat-checkbox>
                </div>

                @if (!paymentForm.get('billingSameAsShipping')?.value) {
                  <div class="billing-address-form full-width">
                    <div class="form-grid" [formGroup]="billingForm">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Dirección línea 1 *</mat-label>
                        <input
                          matInput
                          formControlName="addressLine1"
                          placeholder="Calle Principal 123"
                        />
                        <mat-error>Este campo es requerido</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Dirección línea 2</mat-label>
                        <input
                          matInput
                          formControlName="addressLine2"
                          placeholder="Apartamento, suite, etc."
                        />
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Ciudad *</mat-label>
                        <input matInput formControlName="city" placeholder="Buenos Aires" />
                        <mat-error>Este campo es requerido</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Estado/Provincia</mat-label>
                        <input matInput formControlName="state" placeholder="CABA" />
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Código postal *</mat-label>
                        <input matInput formControlName="zipCode" placeholder="C1000" />
                        <mat-error>Este campo es requerido</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>País *</mat-label>
                        <mat-select formControlName="country">
                          @for (country of countries; track country.value) {
                            <mat-option [value]="country.value">{{ country.label }}</mat-option>
                          }
                        </mat-select>
                        <mat-error>Este campo es requerido</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                }
              </div>

              <div class="security-notice">
                <mat-icon>info</mat-icon>
                <span
                  >Sus datos de tarjeta son procesados de forma segura por MercadoPago. Nunca
                  almacenamos información sensible de su tarjeta.</span
                >
              </div>

              <button
                mat-raised-button
                type="submit"
                class="submit-button"
                color="primary"
                [disabled]="isInitializingPayment"
              >
                Continuar a revisión
              </button>
            </form>
          </mat-card-content>
        </mat-card>
      }

      <!-- Step 3: Review Order -->
      @if (currentStep() === 3) {
        <!-- Shipping Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>1. Dirección de envío</mat-card-title>
              <button mat-button type="button" (click)="goToStep(1)" class="change-button">
                Cambiar
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div>{{ shippingForm.get('fullName')?.value }}</div>
              <div>{{ shippingForm.get('addressLine1')?.value }}</div>
              @if (shippingForm.get('addressLine2')?.value) {
                <div>{{ shippingForm.get('addressLine2')?.value }}</div>
              }
              <div>
                {{ shippingForm.get('city')?.value }}
                @if (shippingForm.get('state')?.value) {
                  , {{ shippingForm.get('state')?.value }}
                }
                {{ shippingForm.get('zipCode')?.value }}
              </div>
              <div>{{ shippingForm.get('country')?.value }}</div>
              <div class="phone">{{ shippingForm.get('phoneNumber')?.value }}</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Billing Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>Dirección de facturación</mat-card-title>
              <button mat-button type="button" (click)="goToStep(2)" class="change-button">
                Cambiar
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              @if (paymentForm.get('billingSameAsShipping')?.value) {
                <div class="same-address-notice">
                  <mat-icon>check_circle</mat-icon>
                  <span>Misma dirección que el envío</span>
                </div>
              } @else {
                <div>{{ billingForm.get('addressLine1')?.value }}</div>
                @if (billingForm.get('addressLine2')?.value) {
                  <div>{{ billingForm.get('addressLine2')?.value }}</div>
                }
                <div>
                  {{ billingForm.get('city')?.value }}
                  @if (billingForm.get('state')?.value) {
                    , {{ billingForm.get('state')?.value }}
                  }
                  {{ billingForm.get('zipCode')?.value }}
                </div>
                <div>{{ billingForm.get('country')?.value }}</div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Payment Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>2. Método de pago</mat-card-title>
              <button mat-button type="button" (click)="goToStep(2)" class="change-button">
                Cambiar
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div class="payment-info">
                <mat-icon>credit_card</mat-icon>
                <span
                  >Tarjeta terminando en
                  {{ getLastFourDigits(paymentForm.get('cardNumber')?.value) }}</span
                >
              </div>
              <div>{{ paymentForm.get('cardholderName')?.value }}</div>
              <div class="payment-security">
                <mat-icon>lock</mat-icon>
                <span>Pago seguro con MercadoPago</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Items Review -->
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <mat-card-title>3. Revisar pedido</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="items-review">
              @for (item of items(); track item.productId; let last = $last) {
                <div class="review-item">
                  <img [src]="item.imageUrl" [alt]="item.name" class="item-image" />
                  <div class="item-details">
                    <h4>{{ item.name }}</h4>
                    <div class="item-quantity">Cantidad: {{ item.quantity }}</div>
                    <div class="item-price">
                      {{ item.currency }} {{ item.price * item.quantity | number: '1.2-2' }}
                    </div>
                  </div>
                </div>
                @if (!last) {
                  <mat-divider></mat-divider>
                }
              }
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>

    <!-- Order Summary Sidebar -->
    <div class="order-summary">
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Resumen del pedido</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-row">
            <span>Artículos ({{ itemCount() }}):</span>
            <span class="summary-value">${{ subtotal() | number: '1.2-2' }}</span>
          </div>

          <div class="summary-row">
            <span>Envío:</span>
            <span class="summary-value" [class.free]="shipping() === 0">
              @if (shipping() === 0) {
                GRATIS
              } @else {
                ${{ shipping() | number: '1.2-2' }}
              }
            </span>
          </div>

          <div class="summary-row">
            <span>Impuesto estimado:</span>
            <span class="summary-value">${{ tax() | number: '1.2-2' }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="summary-row total">
            <span>Total del pedido:</span>
            <span class="summary-value total-value">${{ total() | number: '1.2-2' }}</span>
          </div>
        </mat-card-content>

        @if (currentStep() === 3) {
          <mat-card-actions>
            <button
              mat-raised-button
              color="primary"
              class="place-order-button"
              (click)="placeOrder()"
              [disabled]="isProcessing"
            >
              @if (isProcessing) {
                <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
                Procesando pedido...
              } @else {
                Realizar pedido
              }
            </button>
          </mat-card-actions>
        }

        <div class="secure-badge">
          <mat-icon>lock</mat-icon>
          <span>Pago seguro y encriptado</span>
        </div>
      </mat-card>
    </div>
  </div>
</div>
