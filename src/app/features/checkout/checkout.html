<div class="checkout-container">
  <!-- Progress Steps -->
  <mat-card class="progress-card">
    <div class="progress-steps">
      @for (step of getSteps(); track step.id; let last = $last) {
        <div class="step-wrapper">
          <div class="step-item">
            <div
              class="step-indicator"
              [class.completed]="step.completed"
              [class.active]="currentStep() === step.id"
            >
              @if (step.completed) {
                <mat-icon>check</mat-icon>
              } @else {
                {{ step.id }}
              }
            </div>
            <span class="step-title" [class.active]="currentStep() === step.id">{{
              step.title
            }}</span>
          </div>
          @if (!last) {
            <div class="step-divider" [class.completed]="step.completed"></div>
          }
        </div>
      }
    </div>
  </mat-card>

  <div class="checkout-content">
    <!-- Main Content -->
    <div class="checkout-main">
      <!-- Step 1: Shipping Address -->
      @if (currentStep() === 1) {
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>place</mat-icon>
              </div>
              <mat-card-title>1. {{ 'CHECKOUT.STEP_SHIPPING' | translate }}</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="shippingForm" (ngSubmit)="submitShippingForm()">
              <div class="form-grid">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.FULL_NAME' | translate }} *</mat-label>
                  <input matInput formControlName="fullName" placeholder="Juan PÃ©rez" />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.PHONE' | translate }} *</mat-label>
                  <input
                    matInput
                    type="tel"
                    formControlName="phoneNumber"
                    placeholder="+54 11 1234-5678"
                  />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.ADDRESS_LINE_1' | translate }} *</mat-label>
                  <input
                    matInput
                    formControlName="addressLine1"
                    placeholder="Calle Principal 123"
                  />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.ADDRESS_LINE_2' | translate }}</mat-label>
                  <input
                    matInput
                    formControlName="addressLine2"
                    placeholder="Apartamento, suite, etc."
                  />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.CITY' | translate }} *</mat-label>
                  <input matInput formControlName="city" placeholder="Buenos Aires" />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.STATE_PROVINCE' | translate }}</mat-label>
                  <input matInput formControlName="state" placeholder="CABA" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.POSTAL_CODE' | translate }} *</mat-label>
                  <input matInput formControlName="zipCode" placeholder="C1000" />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.COUNTRY' | translate }} *</mat-label>
                  <mat-select formControlName="country">
                    @for (country of countries; track country.value) {
                      <mat-option [value]="country.value">{{ country.label }}</mat-option>
                    }
                  </mat-select>
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>
              </div>

              <button mat-raised-button type="submit" class="submit-button" color="primary">
                {{ 'CHECKOUT.CONTINUE_TO_PAYMENT' | translate }}
              </button>
            </form>
          </mat-card-content>
        </mat-card>
      }

      <!-- Step 2: Payment Method -->
      @if (currentStep() === 2) {
        <!-- Shipping Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>1. {{ 'CHECKOUT.STEP_SHIPPING' | translate }}</mat-card-title>
              <button mat-button type="button" (click)="goToStep(1)" class="change-button">
                {{ 'CHECKOUT.CHANGE' | translate }}
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div>{{ shippingForm.get('fullName')?.value }}</div>
              <div>{{ shippingForm.get('addressLine1')?.value }}</div>
              @if (shippingForm.get('addressLine2')?.value) {
                <div>{{ shippingForm.get('addressLine2')?.value }}</div>
              }
              <div>
                {{ shippingForm.get('city')?.value }}
                @if (shippingForm.get('state')?.value) {
                  , {{ shippingForm.get('state')?.value }}
                }
                {{ shippingForm.get('zipCode')?.value }}
              </div>
              <div>{{ shippingForm.get('country')?.value }}</div>
              <div class="phone">{{ shippingForm.get('phoneNumber')?.value }}</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Payment Form -->
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>credit_card</mat-icon>
              </div>
              <mat-card-title>2. {{ 'CHECKOUT.STEP_PAYMENT' | translate }}</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="secure-info">
              <mat-icon>lock</mat-icon>
              <span>{{ 'CHECKOUT.SECURE_TRANSACTION' | translate }}</span>
            </div>

            @if (isDevMode) {
              <div class="dev-mode-notice">
                <mat-icon>developer_mode</mat-icon>
                <div class="dev-mode-content">
                  <strong>{{ 'CHECKOUT.DEV_MODE' | translate }}</strong>
                  <span>{{ 'CHECKOUT.DEV_MODE_MESSAGE' | translate }}</span>
                  <div class="dev-mode-test-codes">
                    <strong>{{ 'CHECKOUT.DEV_MODE_CARDHOLDER_NAME' | translate }}</strong>
                    <table class="test-codes-table">
                      <tbody>
                        <tr>
                          <td>APRO</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_APRO' | translate }}</td>
                        </tr>
                        <tr>
                          <td>CALL</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_CALL' | translate }}</td>
                        </tr>
                        <tr>
                          <td>FUND</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_FUND' | translate }}</td>
                        </tr>
                        <tr>
                          <td>SECU</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_SECU' | translate }}</td>
                        </tr>
                        <tr>
                          <td>EXPI</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_EXPI' | translate }}</td>
                        </tr>
                        <tr>
                          <td>FORM</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_FORM' | translate }}</td>
                        </tr>
                        <tr>
                          <td>OTHE</td>
                          <td>{{ 'CHECKOUT.DEV_CODE_OTHE' | translate }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            }

            @if (isInitializingPayment) {
              <div class="loading-payment">
                <mat-spinner diameter="40"></mat-spinner>
                <p>{{ 'CHECKOUT.INITIALIZING_PAYMENT' | translate }}</p>
              </div>
            }

            <form [formGroup]="paymentForm" (ngSubmit)="submitPaymentForm()">
              <div class="form-grid">
                <!-- Card Information -->
                <div class="section-title full-width">{{ 'CHECKOUT.CARD_INFO' | translate }}</div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.CARD_NUMBER' | translate }} *</mat-label>
                  <input
                    matInput
                    formControlName="cardNumber"
                    placeholder="1234 5678 9012 3456"
                    (input)="formatCardNumber($event)"
                    maxlength="19"
                  />
                  <mat-icon matSuffix>credit_card</mat-icon>
                  <mat-error>{{ 'CHECKOUT.CARD_NUMBER_INVALID' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CHECKOUT.CARDHOLDER_NAME' | translate }} *</mat-label>
                  <input
                    matInput
                    formControlName="cardholderName"
                    placeholder="JUAN PEREZ"
                    style="text-transform: uppercase"
                  />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.EXPIRY_MONTH' | translate }} *</mat-label>
                  <input
                    matInput
                    formControlName="expirationMonth"
                    placeholder="12"
                    (input)="formatExpirationMonth($event)"
                    maxlength="2"
                  />
                  <mat-error>{{ 'CHECKOUT.INVALID_MONTH' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.EXPIRY_YEAR' | translate }} *</mat-label>
                  <input
                    matInput
                    formControlName="expirationYear"
                    placeholder="25"
                    (input)="formatExpirationYear($event)"
                    maxlength="2"
                  />
                  <mat-error>{{ 'CHECKOUT.INVALID_YEAR' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.CVV' | translate }} *</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="cvv"
                    placeholder="123"
                    (input)="formatCVV($event)"
                    maxlength="4"
                  />
                  <mat-icon matSuffix [matTooltip]="'CHECKOUT.CVV_TOOLTIP' | translate"
                    >help_outline</mat-icon
                  >
                  <mat-error>{{ 'CHECKOUT.INVALID_CVV' | translate }}</mat-error>
                </mat-form-field>

                <!-- Cardholder Identification -->
                <div class="section-title full-width">
                  {{ 'CHECKOUT.CARDHOLDER_ID' | translate }}
                </div>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.DOCUMENT_TYPE' | translate }} *</mat-label>
                  <mat-select formControlName="identificationType">
                    @for (idType of identificationTypes; track idType.id) {
                      <mat-option [value]="idType.id">{{ idType.name }}</mat-option>
                    }
                  </mat-select>
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{ 'CHECKOUT.DOCUMENT_NUMBER' | translate }} *</mat-label>
                  <input matInput formControlName="identificationNumber" placeholder="12345678" />
                  <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                </mat-form-field>

                <!-- Billing Address Section -->
                <div class="section-title full-width">
                  {{ 'CHECKOUT.BILLING_ADDRESS' | translate }}
                </div>

                <div class="checkbox-field full-width">
                  <mat-checkbox formControlName="billingSameAsShipping">
                    {{ 'CHECKOUT.USE_SHIPPING_ADDRESS' | translate }}
                  </mat-checkbox>
                </div>

                @if (!paymentForm.get('billingSameAsShipping')?.value) {
                  <div class="billing-address-form full-width">
                    <div class="form-grid" [formGroup]="billingForm">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{ 'CHECKOUT.ADDRESS_LINE_1' | translate }} *</mat-label>
                        <input
                          matInput
                          formControlName="addressLine1"
                          placeholder="Calle Principal 123"
                        />
                        <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{ 'CHECKOUT.ADDRESS_LINE_2' | translate }}</mat-label>
                        <input
                          matInput
                          formControlName="addressLine2"
                          placeholder="Apartamento, suite, etc."
                        />
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'CHECKOUT.CITY' | translate }} *</mat-label>
                        <input matInput formControlName="city" placeholder="Buenos Aires" />
                        <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'CHECKOUT.STATE_PROVINCE' | translate }}</mat-label>
                        <input matInput formControlName="state" placeholder="CABA" />
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'CHECKOUT.POSTAL_CODE' | translate }} *</mat-label>
                        <input matInput formControlName="zipCode" placeholder="C1000" />
                        <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'CHECKOUT.COUNTRY' | translate }} *</mat-label>
                        <mat-select formControlName="country">
                          @for (country of countries; track country.value) {
                            <mat-option [value]="country.value">{{ country.label }}</mat-option>
                          }
                        </mat-select>
                        <mat-error>{{ 'CHECKOUT.FIELD_REQUIRED' | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                }
              </div>

              <div class="security-notice">
                <mat-icon>info</mat-icon>
                <span>{{ 'CHECKOUT.SECURE_DATA_MESSAGE' | translate }}</span>
              </div>

              <button
                mat-raised-button
                type="submit"
                class="submit-button"
                color="primary"
                [disabled]="isInitializingPayment"
              >
                {{ 'CHECKOUT.CONTINUE_TO_REVIEW' | translate }}
              </button>
            </form>
          </mat-card-content>
        </mat-card>
      }

      <!-- Step 3: Review Order -->
      @if (currentStep() === 3) {
        <!-- Shipping Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>1. {{ 'CHECKOUT.STEP_SHIPPING' | translate }}</mat-card-title>
              <button mat-button type="button" (click)="goToStep(1)" class="change-button">
                {{ 'CHECKOUT.CHANGE' | translate }}
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div>{{ shippingForm.get('fullName')?.value }}</div>
              <div>{{ shippingForm.get('addressLine1')?.value }}</div>
              @if (shippingForm.get('addressLine2')?.value) {
                <div>{{ shippingForm.get('addressLine2')?.value }}</div>
              }
              <div>
                {{ shippingForm.get('city')?.value }}
                @if (shippingForm.get('state')?.value) {
                  , {{ shippingForm.get('state')?.value }}
                }
                {{ shippingForm.get('zipCode')?.value }}
              </div>
              <div>{{ shippingForm.get('country')?.value }}</div>
              <div class="phone">{{ shippingForm.get('phoneNumber')?.value }}</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Billing Address Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>{{ 'CHECKOUT.BILLING_ADDRESS' | translate }}</mat-card-title>
              <button mat-button type="button" (click)="goToStep(2)" class="change-button">
                {{ 'CHECKOUT.CHANGE' | translate }}
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              @if (paymentForm.get('billingSameAsShipping')?.value) {
                <div class="same-address-notice">
                  <mat-icon>check_circle</mat-icon>
                  <span>{{ 'CHECKOUT.SAME_AS_SHIPPING' | translate }}</span>
                </div>
              } @else {
                <div>{{ billingForm.get('addressLine1')?.value }}</div>
                @if (billingForm.get('addressLine2')?.value) {
                  <div>{{ billingForm.get('addressLine2')?.value }}</div>
                }
                <div>
                  {{ billingForm.get('city')?.value }}
                  @if (billingForm.get('state')?.value) {
                    , {{ billingForm.get('state')?.value }}
                  }
                  {{ billingForm.get('zipCode')?.value }}
                </div>
                <div>{{ billingForm.get('country')?.value }}</div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Payment Review -->
        <mat-card class="review-card">
          <mat-card-header>
            <div class="review-header">
              <div class="review-icon completed">
                <mat-icon>check</mat-icon>
              </div>
              <mat-card-title>2. {{ 'CHECKOUT.STEP_PAYMENT' | translate }}</mat-card-title>
              <button mat-button type="button" (click)="goToStep(2)" class="change-button">
                {{ 'CHECKOUT.CHANGE' | translate }}
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="review-content">
              <div class="payment-info">
                <mat-icon>credit_card</mat-icon>
                <span
                  >{{ 'CHECKOUT.CARD_ENDING_IN' | translate }}
                  {{ getLastFourDigits(paymentForm.get('cardNumber')?.value) }}</span
                >
              </div>
              <div>{{ paymentForm.get('cardholderName')?.value }}</div>
              <div class="payment-security">
                <mat-icon>lock</mat-icon>
                <span>{{ 'CHECKOUT.SECURE_PAYMENT_WITH_MP' | translate }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Items Review -->
        <mat-card class="step-card">
          <mat-card-header>
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <mat-card-title>3. {{ 'CHECKOUT.STEP_REVIEW' | translate }}</mat-card-title>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="items-review">
              @for (item of items(); track item.productId; let last = $last) {
                <div class="review-item">
                  <img [src]="item.imageUrl" [alt]="item.name" class="item-image" />
                  <div class="item-details">
                    <h4>{{ item.name }}</h4>
                    <div class="item-quantity">Cantidad: {{ item.quantity }}</div>
                    <div class="item-price">
                      {{ item.currency }} {{ item.price * item.quantity | number: '1.2-2' }}
                    </div>
                  </div>
                </div>
                @if (!last) {
                  <mat-divider></mat-divider>
                }
              }
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>

    <!-- Order Summary Sidebar -->
    <div class="order-summary">
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>{{ 'CHECKOUT.ORDER_SUMMARY' | translate }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-row">
            <span>{{ 'CHECKOUT.ITEMS' | translate }} ({{ itemCount() }}):</span>
            <span class="summary-value">${{ subtotal() | number: '1.2-2' }}</span>
          </div>

          <div class="summary-row">
            <span>{{ 'CHECKOUT.SHIPPING' | translate }}:</span>
            <span class="summary-value" [class.free]="shipping() === 0">
              @if (shipping() === 0) {
                GRATIS
              } @else {
                ${{ shipping() | number: '1.2-2' }}
              }
            </span>
          </div>

          <div class="summary-row">
            <span>{{ 'CHECKOUT.ESTIMATED_TAX' | translate }}:</span>
            <span class="summary-value">${{ tax() | number: '1.2-2' }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="summary-row total">
            <span>{{ 'CHECKOUT.ORDER_TOTAL' | translate }}:</span>
            <span class="summary-value total-value">${{ total() | number: '1.2-2' }}</span>
          </div>
        </mat-card-content>

        @if (currentStep() === 3) {
          <mat-card-actions>
            <button
              mat-raised-button
              color="primary"
              class="place-order-button"
              (click)="placeOrder()"
              [disabled]="isProcessing"
            >
              @if (isProcessing) {
                <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
                {{ 'CHECKOUT.PROCESSING_ORDER' | translate }}
              } @else {
                {{ 'CHECKOUT.PLACE_ORDER' | translate }}
              }
            </button>
          </mat-card-actions>
        }

        <!-- Demo Platform Warning (only in production mode) -->
        @if (isProdMode) {
          <div class="demo-warning">
            <mat-icon>info</mat-icon>
            <div class="demo-warning-content">
              <strong>Plataforma Demostrativa</strong>
              <span>
                A pesar de estar en Modo Produccion, el fin de esta plataforma es demostrativo.
                MercadoPago esta configurado para cobrar solamente <strong>$20 ARS</strong> sin
                importar el monto del carrito. Realice pruebas con toda confianza.
              </span>
            </div>
          </div>
        }

        <div class="secure-badge">
          <mat-icon>lock</mat-icon>
          <span>{{ 'CHECKOUT.SECURE_PAYMENT' | translate }}</span>
        </div>
      </mat-card>
    </div>
  </div>
</div>
